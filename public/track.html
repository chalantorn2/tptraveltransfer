<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Driver Tracking - TP Travel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .animate-pulse-custom {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-cyan-50 to-blue-50 min-h-screen">
    <div id="app" class="p-4">
      <!-- Loading State -->
      <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
          <i class="fas fa-spinner fa-spin text-4xl text-cyan-600 mb-4"></i>
          <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
      </div>

      <!-- Error State -->
      <div id="error" class="hidden">
        <div class="max-w-md mx-auto mt-20">
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="text-red-600 text-center">
              <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
              <h2 class="text-xl font-semibold mb-2">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</h2>
              <p id="error-message" class="text-gray-700"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div id="content" class="hidden max-w-md mx-auto space-y-4 py-4">
        <!-- Header Card -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold text-gray-900">üöó Transfer</h1>
            <span
              id="status-badge"
              class="px-3 py-1 rounded-full text-sm font-medium"
            >
              ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
            </span>
          </div>
          <div class="space-y-2 text-sm">
            <p class="text-gray-500">Booking Ref:</p>
            <p id="booking-ref" class="text-lg font-semibold text-cyan-600">
              -
            </p>
          </div>
        </div>

        <!-- Booking Info Card -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-lg font-semibold mb-4 text-gray-900">
            üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
          </h2>
          <div class="space-y-3">
            <div class="flex items-start gap-3">
              <i class="fas fa-user text-cyan-600 mt-1"></i>
              <div>
                <p class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£</p>
                <p id="passenger-name" class="font-medium">-</p>
                <p id="passenger-phone" class="text-sm text-gray-600">-</p>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <i class="fas fa-map-marker-alt text-green-600 mt-1"></i>
              <div class="flex-1">
                <p class="text-sm text-gray-500">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö</p>
                <p id="pickup-location" class="font-medium">-</p>
                <p id="pickup-datetime" class="text-sm text-cyan-600">-</p>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <i class="fas fa-map-marker-alt text-red-600 mt-1"></i>
              <div>
                <p class="text-sm text-gray-500">‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á</p>
                <p id="dropoff-location" class="font-medium">-</p>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <i class="fas fa-users text-purple-600"></i>
              <div>
                <p class="text-sm text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£</p>
                <p id="pax" class="font-medium">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- GPS Status Card -->
        <div
          id="gps-status"
          class="hidden bg-green-50 border-2 border-green-200 rounded-xl p-4"
        >
          <div class="flex items-center gap-3 mb-2">
            <i class="fas fa-satellite-dish text-green-600 text-xl"></i>
            <h3 class="font-semibold text-green-900">GPS ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
          </div>
          <div class="text-sm text-green-800 space-y-1">
            <p id="gps-lat">üìç Lat: -</p>
            <p id="gps-lng">üìç Lng: -</p>
            <p id="gps-accuracy">üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: -</p>
            <p id="gps-interval" class="text-xs text-green-600 mt-2">-</p>
          </div>
        </div>

        <!-- Date Validation Warning -->
        <div
          id="date-warning"
          class="hidden bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4"
        >
          <div class="flex items-start gap-3">
            <i
              class="fas fa-exclamation-triangle text-yellow-600 text-xl mt-1"
            ></i>
            <div class="flex-1">
              <h3
                class="font-semibold text-yellow-900 mb-1"
                id="date-warning-title"
              >
                ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
              </h3>
              <p class="text-sm text-yellow-800" id="date-warning-message">-</p>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="space-y-3">
          <button
            id="btn-start"
            class="hidden w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-semibold text-lg shadow-lg hover:from-green-600 hover:to-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <i class="fas fa-play-circle mr-2"></i>
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô
          </button>

          <button
            id="btn-complete"
            class="hidden w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-xl font-semibold text-lg shadow-lg hover:from-blue-600 hover:to-blue-700 transition-all"
          >
            <i class="fas fa-check-circle mr-2"></i>
            ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô
          </button>

          <div
            id="completed-state"
            class="hidden bg-blue-50 border-2 border-blue-200 rounded-xl p-6 text-center"
          >
            <i class="fas fa-check-circle text-blue-600 text-5xl mb-3"></i>
            <h3 class="text-xl font-semibold text-blue-900 mb-2">
              ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!
            </h3>
            <p class="text-blue-700">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
          </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-sm text-gray-500 pt-4">
          <p>TP Travel</p>
          <p id="expires-at" class="text-xs">-</p>
        </div>
      </div>
    </div>

    <script>
      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token =
        urlParams.get("token") || window.location.pathname.split("/").pop();

      let trackingInfo = null;
      let currentStatus = "idle";
      let trackingInterval = null;
      let currentLocation = null;
      let canStartTracking = false;

      // Elements
      const els = {
        loading: document.getElementById("loading"),
        error: document.getElementById("error"),
        errorMessage: document.getElementById("error-message"),
        content: document.getElementById("content"),
        statusBadge: document.getElementById("status-badge"),
        bookingRef: document.getElementById("booking-ref"),
        passengerName: document.getElementById("passenger-name"),
        passengerPhone: document.getElementById("passenger-phone"),
        pickupLocation: document.getElementById("pickup-location"),
        pickupDatetime: document.getElementById("pickup-datetime"),
        dropoffLocation: document.getElementById("dropoff-location"),
        pax: document.getElementById("pax"),
        dateWarning: document.getElementById("date-warning"),
        dateWarningTitle: document.getElementById("date-warning-title"),
        dateWarningMessage: document.getElementById("date-warning-message"),
        gpsStatus: document.getElementById("gps-status"),
        gpsLat: document.getElementById("gps-lat"),
        gpsLng: document.getElementById("gps-lng"),
        gpsAccuracy: document.getElementById("gps-accuracy"),
        gpsInterval: document.getElementById("gps-interval"),
        btnStart: document.getElementById("btn-start"),
        btnComplete: document.getElementById("btn-complete"),
        completedState: document.getElementById("completed-state"),
        expiresAt: document.getElementById("expires-at"),
      };

      // Initialize
      if (!token) {
        showError("‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå");
      } else {
        fetchTrackingInfo();
      }

      async function fetchTrackingInfo() {
        try {
          const response = await fetch(`/api/tracking/info.php?token=${token}`);
          const data = await response.json();

          if (data.success) {
            trackingInfo = data.data;
            renderTrackingInfo();

            if (trackingInfo.status === "active") {
              currentStatus = "tracking";
              startTracking();
            } else if (trackingInfo.status === "completed") {
              currentStatus = "completed";
            }

            updateUI();
          } else {
            showError(data.error || "‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß");
          }
        } catch (err) {
          console.error("Error:", err);
          showError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
        }
      }

      function renderTrackingInfo() {
        els.bookingRef.textContent = trackingInfo.booking_ref;
        els.passengerName.textContent = trackingInfo.booking.passenger_name;
        els.passengerPhone.textContent = trackingInfo.booking.passenger_phone;
        els.pickupLocation.textContent = trackingInfo.booking.pickup_location;
        els.pickupDatetime.textContent = trackingInfo.booking.pickup_datetime;
        els.dropoffLocation.textContent = trackingInfo.booking.dropoff_location;
        els.pax.textContent = trackingInfo.booking.pax + " ‡∏Ñ‡∏ô";
        els.expiresAt.textContent =
          "‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: " +
          new Date(trackingInfo.expires_at).toLocaleString("th-TH");
        els.gpsInterval.textContent = `‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏∏‡∏Å ${trackingInfo.tracking.interval} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;

        // Check if can start tracking based on pickup date
        checkDateRange();

        els.loading.classList.add("hidden");
        els.content.classList.remove("hidden");
      }

      function checkDateRange() {
        if (!trackingInfo.pickup_date) {
          canStartTracking = true;
          return;
        }

        const pickupDate = new Date(trackingInfo.pickup_date);
        const now = new Date();

        // Calculate allowed time range: from pickup_date to +24 hours
        const startAllowed = new Date(pickupDate);
        const endAllowed = new Date(pickupDate);
        endAllowed.setHours(endAllowed.getHours() + 24);

        const formatDateTimeThai = (date) => {
          return date.toLocaleString("th-TH", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        };

        if (now < startAllowed) {
          // Too early
          canStartTracking = false;
          els.dateWarning.classList.remove("hidden");
          els.dateWarningTitle.textContent = "‚è∞ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô";
          els.dateWarningMessage.innerHTML = `‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà<br><strong>${formatDateTimeThai(
            startAllowed
          )}</strong>`;
        } else if (now > endAllowed) {
          // Too late
          canStartTracking = false;
          els.dateWarning.classList.remove("hidden");
          els.dateWarning.className =
            "bg-red-50 border-2 border-red-200 rounded-xl p-4";
          els.dateWarningTitle.textContent = "‚ö†Ô∏è ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß";
          els.dateWarningTitle.className = "font-semibold text-red-900 mb-1";
          els.dateWarningMessage.className = "text-sm text-red-800";
          els.dateWarningMessage.innerHTML = `‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á: ${formatDateTimeThai(
            pickupDate
          )}<br>‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${formatDateTimeThai(
            startAllowed
          )} - ${formatDateTimeThai(
            endAllowed
          )}<br>‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà`;
        } else {
          // Within allowed range (pickup time to +24 hours)
          canStartTracking = true;
          els.dateWarning.classList.add("hidden");
        }
      }

      function updateUI() {
        if (currentStatus === "idle") {
          els.statusBadge.textContent = "‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô";
          els.statusBadge.className =
            "px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800";
          els.btnStart.classList.remove("hidden");
          els.btnStart.disabled = !canStartTracking;
          els.btnComplete.classList.add("hidden");
          els.completedState.classList.add("hidden");
          els.gpsStatus.classList.add("hidden");
        } else if (currentStatus === "tracking") {
          els.statusBadge.textContent = "üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
          els.statusBadge.className =
            "px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 animate-pulse-custom";
          els.btnStart.classList.add("hidden");
          els.btnComplete.classList.remove("hidden");
          els.completedState.classList.add("hidden");
          els.gpsStatus.classList.remove("hidden");
        } else if (currentStatus === "completed") {
          els.statusBadge.textContent = "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
          els.statusBadge.className =
            "px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800";
          els.btnStart.classList.add("hidden");
          els.btnComplete.classList.add("hidden");
          els.completedState.classList.remove("hidden");
          els.gpsStatus.classList.add("hidden");
        }
      }

      async function startJob() {
        if (!canStartTracking) {
          alert(
            "‚è∞ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô"
          );
          return;
        }

        if (!navigator.geolocation) {
          alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
          return;
        }

        try {
          // Get initial location
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              // Start job
              const response = await fetch("/api/tracking/start.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token }),
              });

              const data = await response.json();

              if (data.success) {
                currentStatus = "tracking";
                updateUI();
                await sendLocation(position);
                startTracking();
                alert("‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! GPS ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
              } else {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: " + data.error);
              }
            },
            (error) => {
              console.error("GPS Error:", error);
              alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á GPS ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        } catch (err) {
          console.error("Start job error:", err);
          alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ");
        }
      }

      function startTracking() {
        sendLocationUpdate();

        if (trackingInterval) clearInterval(trackingInterval);

        trackingInterval = setInterval(() => {
          sendLocationUpdate();
        }, (trackingInfo?.tracking?.interval || 30) * 1000);
      }

      function sendLocationUpdate() {
        navigator.geolocation.getCurrentPosition(
          (position) => sendLocation(position),
          (error) => console.error("GPS Error:", error),
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }

      async function sendLocation(position) {
        const location = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          accuracy: position.coords.accuracy,
          status: "BEFORE_PICKUP",
        };

        currentLocation = location;
        updateGPSDisplay(location);

        try {
          await fetch("/api/tracking/location.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, ...location }),
          });
        } catch (err) {
          console.error("Error sending location:", err);
        }
      }

      function updateGPSDisplay(location) {
        els.gpsLat.textContent = `üìç Lat: ${location.latitude.toFixed(6)}`;
        els.gpsLng.textContent = `üìç Lng: ${location.longitude.toFixed(6)}`;
        els.gpsAccuracy.textContent = `üéØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${location.accuracy.toFixed(
          0
        )} ‡πÄ‡∏°‡∏ï‡∏£`;
      }

      async function completeJob() {
        if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

        if (trackingInterval) clearInterval(trackingInterval);

        try {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const response = await fetch("/api/tracking/complete.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  token,
                  status: "COMPLETED",
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude,
                  notes: "Completed by driver",
                }),
              });

              const data = await response.json();

              if (data.success) {
                currentStatus = "completed";
                updateUI();
                alert("‚úÖ ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!");
              } else {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: " + data.error);
              }
            },
            async () => {
              // Complete without location
              const response = await fetch("/api/tracking/complete.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  token,
                  status: "COMPLETED",
                  notes: "Completed by driver (no final location)",
                }),
              });

              const data = await response.json();
              if (data.success) {
                currentStatus = "completed";
                updateUI();
                alert("‚úÖ ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!");
              }
            }
          );
        } catch (err) {
          console.error("Complete job error:", err);
          alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ");
        }
      }

      function showError(message) {
        els.loading.classList.add("hidden");
        els.errorMessage.textContent = message;
        els.error.classList.remove("hidden");
      }

      // Event listeners
      els.btnStart.addEventListener("click", startJob);
      els.btnComplete.addEventListener("click", completeJob);
    </script>
  </body>
</html>
